{"version":3,"sources":["../../src/utils/observer/index.ts","../../src/utils/debounce.ts","../../src/domain/html/index.ts","../../src/services/gitlab/selectors.ts","../../src/services/gitlab/index.ts","../../src/utils/html/index.ts","../../src/features/pn-rule/replacer.ts","../../src/features/pn-rule/observer.ts","../../src/features/pn-rule/index.ts","../../src/features/rm-mr-filter/utils.ts","../../src/features/rm-mr-filter/ui/RemoveButton.ts","../../src/features/rm-mr-filter/index.ts","../../src/features/inject/index.ts"],"sourcesContent":["/**\n * MutationObserver management utilities\n */\n\ntype ObserverEntry = {\n  observer: MutationObserver;\n  target: Node;\n};\n\nconst observers: Map<string, ObserverEntry> = new Map();\n\nexport interface ObserverOptions {\n  id: string;\n  target: Node;\n  callback: MutationCallback;\n  config?: MutationObserverInit;\n}\n\nconst defaultConfig: MutationObserverInit = {\n  childList: true,\n  subtree: true,\n};\n\n/**\n * Creates and registers a MutationObserver\n */\nexport function createObserver(options: ObserverOptions): MutationObserver {\n  const { id, target, callback, config = defaultConfig } = options;\n\n  // Disconnect existing observer with same id\n  if (observers.has(id)) {\n    disconnectObserver(id);\n  }\n\n  const observer = new MutationObserver(callback);\n  observer.observe(target, config);\n\n  observers.set(id, { observer, target });\n\n  return observer;\n}\n\n/**\n * Disconnects a specific observer by id\n */\nexport function disconnectObserver(id: string): boolean {\n  const entry = observers.get(id);\n  if (entry) {\n    entry.observer.disconnect();\n    observers.delete(id);\n    return true;\n  }\n  return false;\n}\n\n/**\n * Disconnects all registered observers\n */\nexport function disconnectAllObservers(): void {\n  observers.forEach((entry) => {\n    entry.observer.disconnect();\n  });\n  observers.clear();\n}\n\n/**\n * Gets the count of active observers\n */\nexport function getObserverCount(): number {\n  return observers.size;\n}\n","export function debounce(func: Function, wait: number) {\n  let timeout: ReturnType<typeof setTimeout> | undefined;\n  return function (this: any, ...args: any[]) {\n    const later = () => {\n      timeout = undefined;\n      func.apply(this, args);\n    };\n    clearTimeout(timeout);\n    timeout = setTimeout(later, wait);\n  };\n}\n","export function genMarker({\n  name,\n  replacement,\n  bgColor,\n  textColor,\n}:{\n  name: string;\n  replacement: string;\n  bgColor?: string;\n  textColor?: string;\n}) {\n  return `<mark name=\"${name}\" style=\"background-color: ${bgColor}; color: ${textColor}\">${replacement}</mark>`;\n}\n","/**\n * GitLab DOM Selectors\n * Centralized selectors for GitLab-specific elements\n */\n\nexport const SELECTORS = {\n  // Note elements in MR discussion\n  notes: \"div.note-body > div.note-text.md [data-sourcepos][dir='auto']\",\n\n  // Filter dropdown elements\n  filterDropdown: 'div.filtered-search-history-dropdown',\n  filterDropdownButton: 'button.filtered-search-history-dropdown-toggle-button',\n  filterListItem: 'li[data-testid=\"dropdown-item\"]:not(.gl-text-subtle)',\n\n  // Custom remove button class\n  customRemoveButton: '.custom-rm-btn',\n} as const;\n\nexport type SelectorKey = keyof typeof SELECTORS;\n","import { SELECTORS } from './selectors';\n\nexport function getNotes() {\n  return document.querySelectorAll(SELECTORS.notes);\n}\n\nexport function getFilterDropdown() {\n  return document.querySelector(SELECTORS.filterDropdown);\n}\n\nexport function getFilterDropdownButton() {\n  return document.querySelector(SELECTORS.filterDropdownButton);\n}\n\nexport function getFilterListItems() {\n  const dropdown = getFilterDropdown();\n  if (!dropdown) return null;\n  return dropdown.querySelectorAll(SELECTORS.filterListItem);\n}\n\nexport { SELECTORS };\n","export function escapeHtml(unsafe: string) {\n  return unsafe\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n};\n","import { genMarker } from \"@domain/html\";\nimport {\n  findPn,\n  getBgColorKey,\n  getReplacementKey,\n  getTextColorKey,\n  isPnRule,\n  PnRuleMapWithColor,\n  PnRuleSub,\n} from \"@domain/pn\";\nimport { getNotes } from \"@services/gitlab\";\nimport { escapeHtml } from \"@utils/html\";\n\n/**\n * Updates existing mark elements with new replacement values\n */\nexport function replaceText(replacementMap: Record<string, string>): void {\n  const marks = document.querySelectorAll(\"mark[name]\");\n\n  marks.forEach((mark) => {\n    if (!(mark instanceof HTMLElement)) return;\n\n    const rule = mark.getAttribute(\"name\")?.toLocaleLowerCase();\n    if (!isPnRule(rule)) return;\n\n    for (const key of Object.keys(replacementMap)) {\n      if (key.startsWith(rule)) {\n        const replacementKey = getReplacementKey(rule);\n        const bgColorKey = getBgColorKey(rule);\n        const textColorKey = getTextColorKey(rule);\n\n        if (replacementMap[replacementKey]) {\n          mark.textContent = escapeHtml(replacementMap[replacementKey]);\n        }\n        if (replacementMap[bgColorKey]) {\n          mark.style.backgroundColor = replacementMap[bgColorKey];\n        }\n        if (replacementMap[textColorKey]) {\n          mark.style.color = replacementMap[textColorKey];\n        }\n      }\n    }\n  });\n}\n\n/**\n * Replaces Pn prefixes in notes with styled markers\n */\nexport function replacePnText(replacementMap: PnRuleMapWithColor): void {\n  const notes = getNotes();\n\n  notes.forEach((note) => {\n    const pn = findPn(note.innerHTML);\n\n    if (pn && pn.toLowerCase() in replacementMap) {\n      const replacementKey = getReplacementKey(pn as PnRuleSub);\n      const bgColorKey = getBgColorKey(pn as PnRuleSub);\n      const textColorKey = getTextColorKey(pn as PnRuleSub);\n\n      note.innerHTML = note.innerHTML.replace(\n        pn,\n        genMarker({\n          name: pn,\n          bgColor: replacementMap[bgColorKey],\n          textColor: replacementMap[textColorKey],\n          replacement: escapeHtml(replacementMap[replacementKey]),\n        })\n      );\n    }\n  });\n}\n","import { isPnRuleMap, PnRuleMapWithColor } from \"@domain/pn\";\nimport { createObserver, disconnectObserver } from \"@utils/observer\";\nimport { debounce } from \"@utils/debounce\";\nimport { replacePnText } from \"./replacer\";\n\nconst OBSERVER_ID = \"pn-rule-observer\";\n\n/**\n * Creates a MutationObserver that watches for DOM changes\n * and applies Pn text replacements\n */\nexport function createPnRuleObserver(pnMap: PnRuleMapWithColor): void {\n  const debouncedCallback = debounce((mutations: MutationRecord[]) => {\n    mutations.forEach((mutation) => {\n      if (mutation.type === \"childList\" && isPnRuleMap(pnMap)) {\n        replacePnText(pnMap);\n      }\n    });\n  }, 20);\n\n  createObserver({\n    id: OBSERVER_ID,\n    target: document.body,\n    callback: debouncedCallback,\n    config: { childList: true, subtree: true },\n  });\n}\n\n/**\n * Disconnects the Pn rule observer\n */\nexport function disconnectPnRuleObserver(): void {\n  disconnectObserver(OBSERVER_ID);\n}\n","import { isPnRuleMap, PnRuleMapWithColor } from \"@domain/pn\";\nimport { getAllFromChromeLocalStorage, subscribeToChromeStorage } from \"@utils/chrome\";\nimport { createPnRuleObserver, disconnectPnRuleObserver } from \"./observer\";\nimport { replaceText } from \"./replacer\";\n\nlet unsubscribeStorage: (() => void) | null = null;\n\n/**\n * Initializes the Pn rule feature\n */\nexport async function initPnRule(): Promise<void> {\n  const pnMap = await getAllFromChromeLocalStorage() as PnRuleMapWithColor;\n\n  unsubscribeStorage = subscribeToChromeStorage((changes) => {\n    const tmpMap: Record<string, string> = {};\n    Object.entries(changes).forEach(([key, change]) => {\n      (pnMap as Record<string, unknown>)[key] = change.newValue;\n      tmpMap[key] = change.newValue;\n    });\n    replaceText(tmpMap);\n  });\n\n  if (isPnRuleMap(pnMap)) {\n    createPnRuleObserver(pnMap);\n  }\n}\n\n/**\n * Cleans up the Pn rule feature\n */\nexport function cleanupPnRule(): void {\n  if (unsubscribeStorage) {\n    unsubscribeStorage();\n    unsubscribeStorage = null;\n  }\n  disconnectPnRuleObserver();\n}\n","// interface Filter {\n//   type: string;\n//   value: {\n//     data: string;\n//     operator: string;\n//   };\n//   id: string;\n// }\n\n// type FilterList = Filter[][];\n\ntype FilterList = string[];\n\nexport function getKey() {\n  const url = new URL(window.location.href);\n  const pathname = url.pathname;\n  const [project] = pathname.split(\"/-/\");\n  return `${project.slice(1)}-merge-request-recent-searches`;\n}\n\nexport function getFilterList() {\n  const key = getKey();\n  const value = localStorage.getItem(key);\n  if (!value) return [];\n  return JSON.parse(value) as FilterList;\n}\n\nexport function setFilterList(filterList: FilterList) {\n  const key = getKey();\n  localStorage.setItem(key, JSON.stringify(filterList));\n}\n\nexport function removeFilterByIndex(e: MouseEvent) {\n  const filterList = getFilterList();\n  const li = (e.target as HTMLButtonElement).parentElement?.parentElement;\n  const siblings = Array.from(li?.parentElement?.children ?? []);\n\n  if (!li || siblings.length === 0) {\n    console.warn(`cannot find li or siblings`);\n    return;\n  }\n  const idx = siblings.indexOf(li as Element);\n  if (idx === -1) {\n    console.warn(`cannot find index of ${li} from ${siblings}`);\n    return;\n  }\n  console.log(`remove filter at index ${idx}`, filterList);\n  filterList.splice(idx, 1);\n  setFilterList(filterList);\n}\n","export function RemoveButton() {\n  const removeButton = document.createElement('button');\n  removeButton.type = 'button';\n\n  removeButton.classList.add('custom-rm-btn');\n  removeButton.innerHTML = `\n<svg class=\"s16 close-icon\"><use xlink:href=\"/assets/icons-0b41337f52be73f7bbf9d59b841eb98a6e790dfa1a844644f120a80ce3cc18ba.svg#close\"></use></svg>\n  `;\n  return removeButton;\n}\n","import { getFilterDropdownButton, getFilterListItems, SELECTORS } from \"@services/gitlab\";\nimport { createObserver, disconnectObserver } from \"@utils/observer\";\nimport { removeFilterByIndex } from \"./utils\";\nimport { RemoveButton } from \"./ui/RemoveButton\";\n\nconst OBSERVER_ID = \"rm-mr-filter-observer\";\n\nfunction addRemoveButtonsToFilters(): void {\n  const filterList = getFilterListItems();\n\n  filterList?.forEach((filter) => {\n    if (filter.querySelector(SELECTORS.customRemoveButton)) {\n      return;\n    }\n    const removeButton = RemoveButton();\n\n    filter.appendChild(removeButton);\n\n    removeButton.addEventListener('click', (e) => {\n      e.stopPropagation();\n      e.preventDefault();\n      removeFilterByIndex(e);\n      filter.remove();\n    });\n  });\n}\n\n/**\n * Initializes the filter removal feature\n */\nexport function initRmMrFilter(): void {\n  const button = getFilterDropdownButton();\n  if (!button) return;\n\n  createObserver({\n    id: OBSERVER_ID,\n    target: button,\n    callback: addRemoveButtonsToFilters,\n    config: { childList: true, subtree: true },\n  });\n\n  addRemoveButtonsToFilters();\n}\n\n/**\n * Cleans up the filter removal feature\n */\nexport function cleanupRmMrFilter(): void {\n  disconnectObserver(OBSERVER_ID);\n}\n","/**\n * Content script entry point\n * Orchestrates feature initialization and cleanup\n */\n\nimport { initPnRule, cleanupPnRule } from \"@features/pn-rule\";\nimport { initRmMrFilter, cleanupRmMrFilter } from \"@features/rm-mr-filter\";\n\n/**\n * Initialize all features\n */\nasync function init(): Promise<void> {\n  await initPnRule();\n  initRmMrFilter();\n}\n\n/**\n * Cleanup all features\n */\nfunction cleanup(): void {\n  cleanupPnRule();\n  cleanupRmMrFilter();\n}\n\n// Initialize on load\ninit();\n\n// Cleanup on unload (for SPA navigation)\nwindow.addEventListener('beforeunload', cleanup);\n"],"mappings":"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","names":["OBSERVER_ID"]}